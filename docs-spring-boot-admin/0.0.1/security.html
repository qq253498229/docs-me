<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>安全 :: 我的文档</title>
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">我的文档</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false"
              aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">主页</a>
        <a class="navbar-item" href="https://github.com/qq253498229/docs-me">源代码</a>
        <!--        <div class="navbar-item has-dropdown is-hoverable">-->
        <!--          <a class="navbar-link" href="#">Products</a>-->
        <!--          <div class="navbar-dropdown">-->
        <!--            <a class="navbar-item" href="#">Product A</a>-->
        <!--            <a class="navbar-item" href="#">Product B</a>-->
        <!--            <a class="navbar-item" href="#">Product C</a>-->
        <!--          </div>-->
        <!--        </div>-->
        <!--        <div class="navbar-item has-dropdown is-hoverable">-->
        <!--          <a class="navbar-link" href="#">Services</a>-->
        <!--          <div class="navbar-dropdown">-->
        <!--            <a class="navbar-item" href="#">Service A</a>-->
        <!--            <a class="navbar-item" href="#">Service B</a>-->
        <!--            <a class="navbar-item" href="#">Service C</a>-->
        <!--          </div>-->
        <!--        </div>-->
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary"
               href="https://github.com/qq253498229/docs-me/releases/download/latest/docs.zip">
             下载
            </a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs-spring-boot-admin" data-version="0.0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">SpringBootAdmin文档</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">什么是 Spring Boot Admin（SBA）?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="getting-started.html">入门</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="client.html">客户端应用程序</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="server.html">SBA服务端</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="security.html">安全</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="customizing.html">自定义</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="monitoring-1.5.x.html">监听1.5.x版本的Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="changes-2.x.html">2.x版本的变化</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faqs.html">常见问题</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">SpringBootAdmin文档</span>
    <span class="version">0.0.1</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../../docs-greenworks-js/0.0.1/index.html">Greenworks-JS 文档</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-greenworks-js/0.0.1/index.html">0.0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../docs-pd2/0.0.1/index.html">PD2记录</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-pd2/0.0.1/index.html">0.0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../docs-peerjs/0.0.1/index.html">PEER JS</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-peerjs/0.0.1/index.html">0.0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../docs-actuator/3.3.3/index.html">Spring Boot Actuator</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-actuator/3.3.3/index.html">3.3.3</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <div class="title"><a href="index.html">SpringBootAdmin文档</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">0.0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../docs-steamworks-rs/0.11.0/index.html">Steamworks for Rust</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-steamworks-rs/0.11.0/index.html">0.11.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../docs-tauri/v1/index.html">Tauri API 文档</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-tauri/v1/index.html">v1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../docs-testing-angular/中文/start.html">Testing Angular</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-testing-angular/中文/start.html">中文</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../docs-me/0.0.1/index.html">个人记录</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-me/0.0.1/index.html">0.0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../docs-taiwu/0.0.1/index.html">太吾绘卷</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-taiwu/0.0.1/index.html">0.0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../docs-palworld/0.0.1/index.html">幻兽帕鲁笔记</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../docs-palworld/0.0.1/index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../docs-me/0.0.1/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">SpringBootAdmin文档</a></li>
    <li><a href="security.html">安全</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="https://github.com/qq253498229/docs-spring-boot-admin/edit/2.6.6/modules/ROOT/pages/security.adoc">编辑本页</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="目录" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">安全</h1>
<div class="sect1">
<h2 id="_保护sba服务端的安全"><a class="anchor" href="#_保护sba服务端的安全"></a>1. 保护SBA服务端的安全</h2>
<div class="sectionbody">
<div class="paragraph">
<p>由于在分布式web应用中，有好几种可以解决身份认证和授权的方法，所以Spring Boot Admin没有默认为您选择它们中的哪一个。 默认情况下可以使用 <code>spring-boot-admin-server-ui</code> 来提供一个登录页面和注销按钮。</p>
</div>
<div class="paragraph">
<p>下面是一个针对Spring的安全配置示例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration(proxyBeanMethods = false)
public class SecuritySecureConfig extends WebSecurityConfigurerAdapter {

	private final AdminServerProperties adminServer;

	private final SecurityProperties security;

	public SecuritySecureConfig(AdminServerProperties adminServer, SecurityProperties security) {
		this.adminServer = adminServer;
		this.security = security;
	}

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		SavedRequestAwareAuthenticationSuccessHandler successHandler = new SavedRequestAwareAuthenticationSuccessHandler();
		successHandler.setTargetUrlParameter("redirectTo");
		successHandler.setDefaultTargetUrl(this.adminServer.path("/"));

		http.authorizeRequests(
				(authorizeRequests) -&gt; authorizeRequests.antMatchers(this.adminServer.path("/assets/**")).permitAll() <i class="conum" data-value="1"></i><b>(1)</b>
						.antMatchers(this.adminServer.path("/actuator/info")).permitAll()
						.antMatchers(this.adminServer.path("/actuator/health")).permitAll()
						.antMatchers(this.adminServer.path("/login")).permitAll().anyRequest().authenticated() <i class="conum" data-value="2"></i><b>(2)</b>
		).formLogin(
				(formLogin) -&gt; formLogin.loginPage(this.adminServer.path("/login")).successHandler(successHandler).and() <i class="conum" data-value="3"></i><b>(3)</b>
		).logout((logout) -&gt; logout.logoutUrl(this.adminServer.path("/logout"))).httpBasic(Customizer.withDefaults()) <i class="conum" data-value="4"></i><b>(4)</b>
				.csrf((csrf) -&gt; csrf.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) <i class="conum" data-value="5"></i><b>(5)</b>
						.ignoringRequestMatchers(
								new AntPathRequestMatcher(this.adminServer.path("/instances"),
										HttpMethod.POST.toString()), <i class="conum" data-value="6"></i><b>(6)</b>
								new AntPathRequestMatcher(this.adminServer.path("/instances/*"),
										HttpMethod.DELETE.toString()), <i class="conum" data-value="6"></i><b>(6)</b>
								new AntPathRequestMatcher(this.adminServer.path("/actuator/**")) <i class="conum" data-value="7"></i><b>(7)</b>
						))
				.rememberMe((rememberMe) -&gt; rememberMe.key(UUID.randomUUID().toString()).tokenValiditySeconds(1209600));
	}

	// Required to provide UserDetailsService for "remember functionality"
	@Override
	protected void configure(AuthenticationManagerBuilder auth) throws Exception {
		auth.inMemoryAuthentication().withUser(security.getUser().getName())
				.password("{noop}" + security.getUser().getPassword()).roles("USER");
	}

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>对所有静态资源和登录页面进行放行处理。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>其它所有请求都必须经过身份认证。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>配置登录和注销逻辑。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>开启HTTP-Basic认证。这是Spring Boot Admin客户端所需的。</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>启用Cookie的CSRF保护</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>禁用Spring Boot Admin客户端对于注册（注销）请求的CSRF保护</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>禁用Spring Boot Admin客户端对于actuator接口的CSRF保护</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>如果使用Spring Boot Admin客户端，它还需要添加访问服务端的凭证:</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring.boot.admin.client:
   username: sba-client
   password: s3cret</code></pre>
</div>
</div>
<div class="paragraph">
<p>有关完整的示例，请查看 <a href="https://github.com/codecentric/spring-boot-admin/tree/master/spring-boot-admin-samples/spring-boot-admin-sample-servlet/">spring-boot-admin-sample-servlet</a>。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
如果你想要保护 <code>/instances</code> 接口，那么不要忘了在SBA客户端使用 <code>spring.boot.admin.client.username</code> 和 <code>spring.boot.admin.client.password</code> 配置用户名和密码。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_保护客户端默认actuator接口"><a class="anchor" href="#_保护客户端默认actuator接口"></a>2. 保护客户端默认Actuator接口</h2>
<div class="sectionbody">
<div class="paragraph">
<p>当actuator默认接口使用HTTP Basic身份认证进行安全保护时候，SBA就需要凭证才能访问它们了。 你可以在注册应用的时候在元数据中提交这个凭证。 之后 <code>BasicAuthHttpHeaderProvider</code> 就会使用元数据中提供的信息，在header中添加 <code>Authorization</code> 然后访问客户端应用的actuator接口了。 你也可以自定义一个 <code>HttpHeadersProvider</code> 来改变这个默认的行为（例如添加一些加密揭秘的逻辑）或者是在header中添加额外信息。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
SBA服务端会屏蔽元数据中的一些信息，以防止敏感信息的泄漏。
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
在元数据提交身份凭证时，应该为SBA服务端（或者是服务发现）配置HTTPS。
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
使用Spring Cloud服务发现的时候，你必须随时注意，任何可以查询服务注册的人都可以看到你的认证信息。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
使用这种方法SBA服务端就可以决定用户能否访问已注册的应用。 还有更加复杂的解决方案（使用OAuth2）来让客户端决定用户能否访问接口。 关于这一点，请参考 <a href="https://github.com/joshiste/spring-boot-admin-samples" target="_blank" rel="noopener">joshiste/spring-boot-admin-samples</a>。
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_sba客户端"><a class="anchor" href="#_sba客户端"></a>2.1. SBA客户端</h3>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring.boot.admin.client:
    url: http://localhost:8080
    instance:
      metadata:
        user.name: ${spring.security.user.name}
        user.password: ${spring.security.user.password}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sba服务端"><a class="anchor" href="#_sba服务端"></a>2.2. SBA服务端</h3>
<div class="paragraph">
<p>你可以通过admin服务端的配置文件来指定凭证。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
你可以将它与 <a href="https://cloud.spring.io/spring-cloud-kubernetes/1.1.x/reference/html/#secrets-propertysource" target="_blank" rel="noopener">spring-cloud-kubernetes</a> 结合起来一起使用，这样就能从 <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener">secrets</a> 中读取凭证了。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>要想从配置文件读取凭证，需要将 <code>spring.boot.admin.instance-auth.enabled</code> 设置为 <code>true</code> （默认情况就是这样）。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
如果客户端通过元数据提供了凭证（例如通过服务注解），那么元数据将会替换配置文件中的配置。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>你可以通过使用 <code>spring.boot.admin.instance-auth.default-user-name</code> 和 <code>spring.boot.admin.instance-auth.default-user-password</code> 来提供默认的用户名和密码。 你也可以选择使用 <code>spring.boot.admin.instance-auth.service-map.*.user-name</code> 为指定名称的服务提供凭证，记得将 <code>*</code> 替换为服务名。</p>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring.boot.admin:
  instance-auth:
    enabled: true
    default-user-name: "${some.user.name.from.secret}"
    default-password: "${some.user.password.from.secret}"
    service-map:
      my-first-service-to-monitor:
        user-name: "${some.user.name.from.secret}"
        user-password: "${some.user.password.from.secret}"
      my-second-service-to-monitor:
        user-name: "${some.user.name.from.secret}"
        user-password: "${some.user.password.from.secret}"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_eureka"><a class="anchor" href="#_eureka"></a>2.3. Eureka</h3>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">eureka:
  instance:
    metadata-map:
      user.name: ${spring.security.user.name}
      user.password: ${spring.security.user.password}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_consul"><a class="anchor" href="#_consul"></a>2.4. Consul</h3>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring.cloud.consul:
  discovery:
    metadata:
        user-name: ${spring.security.user.name}
        user-password: ${spring.security.user.password}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Consul在元数据不允许使用点 (".") 作为key，应该使用减号（横杠）代理。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_默认actuator接口的csrf保护"><a class="anchor" href="#_默认actuator接口的csrf保护"></a>2.5. 默认Actuator接口的CSRF保护</h3>
<div class="paragraph">
<p>一些actuator接口 (例如 <code>/loggers</code>) 是支持POST请求的。
在使用Spring Security时需要禁用这些actuator接口的CSRF保护，因为Spring Boot Admin服务端目前缺乏对这方面的支持。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
protected void configure(HttpSecurity http) throws Exception {
    http.csrf()
        .ignoringAntMatchers("/actuator/**");
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用自定义tls"><a class="anchor" href="#_使用自定义tls"></a>3. 使用自定义TLS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SBA还可以在访问actuator接口的时候使用客户端证书进行身份认证。
在提供了 <code>ClientHttpConnector</code> bean时，Spring Boot就会用它自动配置 <code>WebClient.Builder</code>，之后供Spring Boot Admin使用。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public ClientHttpConnector customHttpClient() {
    SslContextBuilder sslContext = SslContextBuilder.forClient();
    //Your sslContext customizations go here
    HttpClient httpClient = HttpClient.create().secure(
        ssl -&gt; ssl.sslContext(sslContext)
    );
    return new ReactorClientHttpConnector(httpClient);
}</code></pre>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
  </body>
</html>
